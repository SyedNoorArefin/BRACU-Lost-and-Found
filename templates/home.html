<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRACU Lost & Found Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-search-location text-primary"></i> BRACU Lost & Found Portal</h2>
        <div>
            {% if session.get('user_id') %}
                <div class="d-flex align-items-center">
                    <div class="me-3 position-relative">
                        <button id="notifBell" class="btn btn-link position-relative" onclick="toggleNotifications()">
                            <i class="fas fa-bell fa-lg"></i>
                            <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                        </button>
                        <div id="notifDropdown" class="card shadow position-absolute end-0 mt-2" style="width: 320px; display: none; z-index: 1050;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-bell"></i> Notifications</span>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('view_all_notifications') }}" class="btn btn-sm btn-outline-primary">View all</a>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="markAllRead()">Mark all as read</button>
                                </div>
                            </div>
                            <ul id="notifList" class="list-group list-group-flush" style="max-height: 360px; overflow-y: auto;"></ul>
                            <div id="noNotif" class="text-center text-muted p-3 d-none">No notifications</div>
                        </div>
                    </div>
                    {% if session.get('profile_photo') %}
                        <img src="{{ url_for('static', filename='uploads/' + session['profile_photo']) }}" 
                             alt="Profile Photo" 
                             class="rounded-circle me-2" 
                             style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle me-2 d-flex align-items-center justify-content-center bg-secondary text-white" 
                             style="width: 40px; height: 40px; font-size: 16px;">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    <span class="me-3">
                        Welcome, 
                        {% if session.get('first_name') and session.get('last_name') %}
                            {{ session['first_name'] }} {{ session['last_name'] }}
                        {% elif session.get('first_name') %}
                            {{ session['first_name'] }}
                        {% else %}
                            {{ session['username'] }}
                        {% endif %}!
                    </span>
                    <a href="{{ url_for('chat_home') }}" class="btn btn-outline-primary btn-sm me-2 position-relative">
                        Chats
                        <span id="chat-status-indicator" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning d-none" 
                              title="Chat disabled due to reports">
                            <i class="fas fa-ban"></i>
                        </span>
                    </a>
                    <a href="{{ url_for('warehouse') }}" class="btn btn-outline-secondary btn-sm me-2">Warehouse</a>
                    <a href="{{ url_for('view_activity_log') }}" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-history"></i> Activity
                    </a>
                    <a href="{{ url_for('profile') }}" class="btn btn-outline-info btn-sm me-2">Profile</a>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
                </div>
            {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm me-2">Login</a>
                <a href="{{ url_for('signup') }}" class="btn btn-outline-success btn-sm">Sign Up</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="container mt-5">
    {% if session.get('pending_undo') %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-undo-alt"></i>
            Do you want to revert removal of <strong>{{ session['pending_undo']['name'] }}</strong>?
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('undo_delete_item', item_id=session['pending_undo']['item_id']) }}" class="btn btn-success btn-sm">
                Yes
            </a>
            <a href="{{ url_for('dismiss_undo') }}" class="btn btn-danger btn-sm">
                No
            </a>
        </div>
    </div>
    {% endif %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <h1 class="display-4 text-primary">Lost Something?</h1>
            <p class="lead">Find your lost items or help others find theirs at BRAC University Campus</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <div class="row">
                <div class="col-md-4 top-row-equal">
                    <div class="card h-100 shadow-sm top-card" style="border: 1px solid #e6f0ff;">
                        <div class="px-4 py-3" style="background: linear-gradient(90deg, #eaf4ff 0%, #f7fbff 100%); border-bottom: 1px solid #e8eef7;">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;background:#e0efff;color:#2563eb;">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold" style="letter-spacing:.2px;">Report Lost Item</div>
                                    <div class="text-muted small">Let the community help you find it</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column justify-content-between">
                            <p class="text-muted mb-4">Lost something on campus? Share details and photos so others can assist.</p>
                            <div class="d-grid">
                                {% if session.get('user_id') %}
                                    <a href="#" class="btn btn-primary btn-lg" style="border-radius:10px;" onclick="showLostItemForm()">
                                        <i class="fas fa-paper-plane"></i> Report Lost Item
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-lg" style="border-radius:10px;">
                                        <i class="fas fa-right-to-bracket"></i> Login to Report
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 top-row-equal">
                    <div class="card h-100 shadow-sm top-card" style="border: 1px solid #dff5ea;">
                        <div class="px-4 py-3" style="background: linear-gradient(90deg, #e9fbf2 0%, #f8fffc 100%); border-bottom: 1px solid #e3f5ec;">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;background:#dcfce7;color:#16a34a;">
                                    <i class="fas fa-hand-holding-heart"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold" style="letter-spacing:.2px;">Report Found Item</div>
                                    <div class="text-muted small">Help the owner get it back quickly</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column justify-content-between">
                            <p class="text-muted mb-4">Found something on campus? Post it here with a photo and location.</p>
                            <div class="d-grid">
                                {% if session.get('user_id') %}
                                    <a href="#" class="btn btn-success btn-lg" style="border-radius:10px;" onclick="showFoundItemForm()">
                                        <i class="fas fa-share-from-square"></i> Report Found Item
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('login') }}" class="btn btn-outline-success btn-lg" style="border-radius:10px;">
                                        <i class="fas fa-right-to-bracket"></i> Login to Report
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 top-row-equal">
                    <div class="card h-100 shadow-sm top-card" style="border: 1px solid #e6f0ff;">
                        <div class="px-4 py-3" style="background: linear-gradient(90deg, #eaf4ff 0%, #f7fbff 100%); border-bottom: 1px solid #e8eef7;">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:42px;height:42px;background:#e0efff;color:#0ea5e9;">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold" style="letter-spacing:.2px;">Search Items</div>
                                    <div class="text-muted small">Filter by item, date, location, or keyword</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <form method="get" action="/">
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Item Name</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="fas fa-tag text-secondary"></i></span>
                                        <input type="text" name="item" value="{{ q_item }}" class="form-control" placeholder="e.g., iPhone, Bottle" />
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small mb-1">Location</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="fas fa-location-dot text-secondary"></i></span>
                                        <input type="text" name="location" value="{{ q_location }}" class="form-control" placeholder="e.g., Library" />
                                    </div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col">
                                        <label class="form-label small mb-1">From</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white"><i class="fas fa-calendar-day text-secondary"></i></span>
                                            <input type="date" name="date_from" value="{{ q_date_from }}" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col">
                                        <label class="form-label small mb-1">To</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white"><i class="fas fa-calendar-check text-secondary"></i></span>
                                            <input type="date" name="date_to" value="{{ q_date_to }}" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small mb-1">Keyword</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white"><i class="fas fa-keyboard text-secondary"></i></span>
                                        <input type="text" name="keyword" value="{{ q_keyword }}" class="form-control" placeholder="Any word in title/description" />
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-rotate-left"></i> Clear</a>
                                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-magnifying-glass"></i> Search</button>
                                </div>
                            </form>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Found Items Section -->
    {% if session.get('user_id') and match_suggestions %}
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">
                <i class="fas fa-lightbulb text-primary"></i> Suggested Matches For Your Lost Items
            </h3>
        </div>
    </div>
    <div class="row mb-4">
        {% for s in match_suggestions %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <strong>Your Lost:</strong> {{ s.lost.name }}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Details</h6>
                            <p class="mb-1"><strong>Name:</strong> {{ s.lost.name }}</p>
                            <p class="mb-1"><strong>Location:</strong> {{ s.lost.location or 'Unknown' }}</p>
                            <p class="mb-2"><strong>Description:</strong> {{ s.lost.description }}</p>
                            {% if s.lost.photos and s.lost.photos[0] %}
                            <img src="{{ url_for('static', filename='uploads/' + s.lost.photos[0]) }}" class="img-fluid rounded border" alt="lost photo">
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h6>Potential Matches</h6>
                            <div class="row">
                                {% for m in s.matches %}
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white">
                                            {{ m.name }}
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-1"><strong>Location:</strong> {{ m.location or 'Unknown' }}</p>
                                            <p class="mb-2 text-truncate" title="{{ m.description }}">{{ m.description }}</p>
                                            {% if m.photos and m.photos[0] %}
                                            <img src="{{ url_for('static', filename='uploads/' + m.photos[0]) }}" class="img-fluid rounded border" alt="match photo">
                                            {% endif %}
                                        </div>
                                        <div class="card-footer bg-light">
                                            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('home') }}#item-{{ m.id }}">Open</a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">
                <i class="fas fa-check-circle text-success"></i> Recent Found Items
            </h3>
        </div>
    </div>

    <div class="row mb-5">
        {% for item in found_items %}
        <div class="col-md-4 mb-3" id="item-{{ item.id }}">
            <div class="card h-100 border-success item-card" data-item='{{ {
                "id": item.id,
                "name": item.name,
                "description": item.description,
                "value": item.value,
                "location": item.location,
                "status": item.status,
                "posted": (item.created_at.strftime("%Y-%m-%d %H:%M") if item.created_at else "Unknown"),
                "photos": item.photos,
                "can_mark_found": false,
                "can_delete": (session.get('user_id') and item.reported_by == session.get('user_id'))
            } | tojson }}'>
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hand-holding-heart"></i> {{ item.name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if item.photos and item.photos|length > 0 %}
                        <div id="carousel-found-{{ item.id }}" class="photo-carousel position-relative mb-3" data-index="0" style="width:100%; height:220px; background:#f8f9fa; border-radius:.5rem; overflow:hidden;">
                            {% for photo in item.photos %}
                                <img src="{{ url_for('static', filename='uploads/' + photo) }}" alt="{{ item.name }}" style="display: none; width:100%; height:100%; object-fit: contain;">
                            {% endfor %}
                            <button class="btn btn-sm btn-dark position-absolute top-50 start-0 translate-middle-y carousel-prev" style="opacity:0.7" data-target-id="carousel-found-{{ item.id }}"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-sm btn-dark position-absolute top-50 end-0 translate-middle-y carousel-next" style="opacity:0.7" data-target-id="carousel-found-{{ item.id }}"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    {% elif item.photo_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + item.photo_filename) }}" 
                             alt="{{ item.name }}" class="img-fluid rounded mb-3" 
                             style="width: 100%; max-height: 220px; object-fit: contain; background:#f8f9fa;">
                    {% endif %}
                    {% if item.value %}
                        <p class="card-text"><strong>Value:</strong> ${{ item.value }}</p>
                    {% endif %}
                    <p class="card-text">{{ item.description }}</p>
                    {% if item.location %}
                        <p class="card-text"><strong>Location Found:</strong> {{ item.location }}</p>
                    {% endif %}
                    
                    <div class="mb-2">
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Found
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt"></i> Posted: {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else 'Unknown' }}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-warning">
                            <i class="fas fa-clock"></i> <span id="timer-found-{{ item.id }}">Loading...</span>
                        </small>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-grid gap-2">
                            <!-- Contact Finder Button for Found Items -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-success btn-sm btn-contact" data-item-id="{{ item.id }}">
                                    <i class="fas fa-phone"></i> Contact Finder
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm btn-chat" data-item-id="{{ item.id }}">
                                    <i class="fas fa-comments"></i>
                                </button>
                            </div>
                            
                            <!-- Claim Item Button for Found Items -->
                            {% if session.get('user_id') %}
                                <a href="{{ url_for('claim_item', item_id=item.id) }}" class="btn btn-warning btn-sm w-100">
                                    <i class="fas fa-handshake"></i> Claimed by Owner
                                </a>
                            {% endif %}
                            
                            <a href="{{ url_for('generate_poster', item_id=item.id) }}" class="btn btn-outline-dark btn-sm">
                                <i class="fas fa-file-pdf"></i> Download Poster (PDF)
                            </a>
                            
                            {% if session.get('user_id') and item.reported_by == session.get('user_id') %}
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 btn-edit" data-item-id="{{ item.id }}" data-item-status="found">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <form action="/delete_product/{{ item.id }}" method="POST" style="flex: 1;" class="form-delete-item">
                                        <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                            
                            <!-- Report Button for Non-Owners -->
                            {% if session.get('user_id') and item.reported_by != session.get('user_id') and item.poster %}
                                <div class="d-flex gap-1 mt-2">
                                    <a href="{{ url_for('report_user', user_id=item.poster.id) }}" class="btn btn-outline-warning btn-sm flex-fill">
                                        <i class="fas fa-user-slash"></i> Report User
                                    </a>
                                </div>
                            {% endif %}
                            
                            <!-- Poster Information with Points and Badges -->
                            {% if item.poster %}
                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>Posted by:</strong> {{ item.poster.username }}
                                    {% if item.poster.return_points > 0 %}
                                        <span class="badge bg-success ms-1">
                                            <i class="fas fa-star"></i> {{ item.poster.return_points }} pts
                                        </span>
                                    {% endif %}
                                </small>
                                {% if item.poster.badges %}
                                <div class="mt-1">
                                    {% for badge in item.poster.badges[:3] %}
                                    <span class="badge bg-warning text-dark me-1" title="{{ badge.badge_description }}">
                                        {% if badge.badge_type == 'first_return' %}
                                            <i class="fas fa-medal"></i>
                                        {% elif badge.badge_type == 'trusted_finder' %}
                                            <i class="fas fa-crown"></i>
                                        {% elif badge.badge_type == 'community_hero' %}
                                            <i class="fas fa-star"></i>
                                        {% endif %}
                                        {{ badge.badge_name }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not found_items %}
    <div class="row mb-5">
        <div class="col-md-12 text-center">
            <div class="alert alert-success">
                <i class="fas fa-info-circle"></i> No found items reported yet. Help others by reporting found items!
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Lost Items Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-warning"></i> Recent Lost Items
            </h3>
        </div>
    </div>

    <div class="row mb-5">
        {% for item in lost_items %}
        <div class="col-md-4 mb-3" id="item-{{ item.id }}">
            <div class="card h-100 border-warning item-card" data-item='{{ {
                "id": item.id,
                "name": item.name,
                "description": item.description,
                "value": item.value,
                "location": item.location,
                "status": item.status,
                "posted": (item.created_at.strftime("%Y-%m-%d %H:%M") if item.created_at else "Unknown"),
                "photos": item.photos,
                "can_mark_found": (session.get('user_id') and item.reported_by == session.get('user_id')),
                "can_delete": (session.get('user_id') and item.reported_by == session.get('user_id'))
            } | tojson }}'>
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> {{ item.name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if item.photos and item.photos|length > 0 %}
                        <div id="carousel-lost-{{ item.id }}" class="photo-carousel position-relative mb-3" data-index="0" style="width:100%; height:220px; background:#f8f9fa; border-radius:.5rem; overflow:hidden;">
                            {% for photo in item.photos %}
                                <img src="{{ url_for('static', filename='uploads/' + photo) }}" alt="{{ item.name }}" style="display: none; width:100%; height:100%; object-fit: contain;">
                            {% endfor %}
                            <button class="btn btn-sm btn-dark position-absolute top-50 start-0 translate-middle-y carousel-prev" style="opacity:0.7" data-target-id="carousel-lost-{{ item.id }}"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-sm btn-dark position-absolute top-50 end-0 translate-middle-y carousel-next" style="opacity:0.7" data-target-id="carousel-lost-{{ item.id }}"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    {% elif item.photo_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + item.photo_filename) }}" 
                             alt="{{ item.name }}" class="img-fluid rounded mb-3" 
                             style="width: 100%; max-height: 220px; object-fit: contain; background:#f8f9fa;">
                    {% endif %}
                    {% if item.value %}
                        <p class="card-text"><strong>Value:</strong> ${{ item.value }}</p>
                    {% endif %}
                    <p class="card-text">{{ item.description }}</p>
                    
                    <div class="mb-2">
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock"></i> Lost
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt"></i> Posted: {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else 'Unknown' }}
                        </small>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-grid gap-2">
                            <!-- Contact Owner Button for Lost Items -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-warning btn-sm btn-contact" data-item-id="{{ item.id }}">
                                    <i class="fas fa-phone"></i> Contact Owner
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm btn-chat" data-item-id="{{ item.id }}">
                                    <i class="fas fa-comments"></i>
                                </button>
                            </div>
                            

                            <a href="{{ url_for('generate_poster', item_id=item.id) }}" class="btn btn-outline-dark btn-sm">
                                <i class="fas fa-file-pdf"></i> Download Poster (PDF)
                            </a>
                            
                            {% if session.get('user_id') and item.reported_by == session.get('user_id') %}
                                <div class="d-flex gap-1">
                                    <!-- Mark as Found Button for Lost Items -->
                                    <a href="{{ url_for('mark_found', item_id=item.id) }}" class="btn btn-info btn-sm flex-fill">
                                        <i class="fas fa-hand-holding-heart"></i> Mark as Found
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill btn-edit" data-item-id="{{ item.id }}" data-item-status="lost">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <form action="/delete_product/{{ item.id }}" method="POST" style="flex: 1;" class="form-delete-item">
                                        <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                            
                            <!-- Report Button for Non-Owners -->
                            {% if session.get('user_id') and item.reported_by != session.get('user_id') and item.poster %}
                                <div class="d-flex gap-1 mt-2">
                                    <a href="{{ url_for('report_user', user_id=item.poster.id) }}" class="btn btn-outline-warning btn-sm flex-fill">
                                        <i class="fas fa-user-slash"></i> Report User
                                    </a>
                                </div>
                            {% endif %}
                            
                            <!-- Poster Information with Points and Badges -->
                            {% if item.poster %}
                            <div class="mt-2 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>Posted by:</strong> {{ item.poster.username }}
                                    {% if item.poster.return_points > 0 %}
                                        <span class="badge bg-success ms-1">
                                            <i class="fas fa-star"></i> {{ item.poster.return_points }} pts
                                        </span>
                                    {% endif %}
                                </small>
                                {% if item.poster.badges %}
                                <div class="mt-1">
                                    {% for badge in item.poster.badges[:3] %}
                                    <span class="badge bg-warning text-dark me-1" title="{{ badge.badge_description }}">
                                        {% if badge.badge_type == 'first_return' %}
                                            <i class="fas fa-medal"></i>
                                        {% elif badge.badge_type == 'trusted_finder' %}
                                            <i class="fas fa-crown"></i>
                                        {% endif %}
                                        {{ badge.badge_name }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not lost_items %}
    <div class="row mb-5">
        <div class="col-md-12 text-center">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> No lost items reported yet. Be the first to report a lost item!
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Warehouse Items Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">
                <a href="{{ url_for('warehouse') }}" class="text-decoration-none text-reset">
                    <i class="fas fa-warehouse text-secondary"></i> Warehouse Items
                </a>
            </h3>
        </div>
    </div>

    <div class="row mb-5">
        {% for item in warehouse_items %}
        <div class="col-md-4 mb-3" id="item-{{ item.id }}">
            <div class="card h-100 border-secondary item-card" data-item='{{ {
                "id": item.id,
                "name": item.name,
                "description": item.description,
                "value": item.value,
                "location": item.location,
                "status": item.status,
                "posted": (item.created_at.strftime("%Y-%m-%d %H:%M") if item.created_at else "Unknown"),
                "photos": item.photos,
                "can_mark_found": false,
                "can_delete": (session.get('user_id') and item.reported_by == session.get('user_id'))
            } | tojson }}'>
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-warehouse"></i> {{ item.name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if item.photos and item.photos|length > 0 %}
                        <div id="carousel-warehouse-{{ item.id }}" class="photo-carousel position-relative mb-3" data-index="0" style="width:100%; height:220px; background:#f8f9fa; border-radius:.5rem; overflow:hidden;">
                            {% for photo in item.photos %}
                                <img src="{{ url_for('static', filename='uploads/' + photo) }}" alt="{{ item.name }}" style="display: none; width:100%; height:100%; object-fit: contain;">
                            {% endfor %}
                            <button class="btn btn-sm btn-dark position-absolute top-50 start-0 translate-middle-y carousel-prev" style="opacity:0.7" data-target-id="carousel-warehouse-{{ item.id }}"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-sm btn-dark position-absolute top-50 end-0 translate-middle-y carousel-next" style="opacity:0.7" data-target-id="carousel-warehouse-{{ item.id }}"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    {% elif item.photo_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + item.photo_filename) }}" 
                             alt="{{ item.name }}" class="img-fluid rounded mb-3" 
                             style="width: 100%; max-height: 220px; object-fit: contain; background:#f8f9fa;">
                    {% endif %}
                    {% if item.value %}
                        <p class="card-text"><strong>Value:</strong> ${{ item.value }}</p>
                    {% endif %}
                    <p class="card-text">{{ item.description }}</p>
                    {% if item.location %}
                        <p class="card-text"><strong>Location Found:</strong> {{ item.location }}</p>
                    {% endif %}
                    
                    <div class="mb-2">
                        <span class="badge bg-secondary">
                            <i class="fas fa-warehouse"></i> In Warehouse
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt"></i> Posted: {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else 'Unknown' }}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Sent to warehouse
                        </small>
                    </div>
                    
                    <div class="mt-3">
                        {% if session.get('user_id') and item.reported_by == session.get('user_id') %}
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('generate_poster', item_id=item.id) }}" class="btn btn-outline-dark btn-sm w-100">
                                    <i class="fas fa-file-pdf"></i> Download Poster (PDF)
                                </a>
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100 btn-edit" data-item-id="{{ item.id }}" data-item-status="warehouse">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form action="/delete_product/{{ item.id }}" method="POST">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100" 
                                            onclick="return confirm('Are you sure you want to remove this item?')">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not warehouse_items %}
    <div class="row mb-5">
        <div class="col-md-12 text-center">
            <div class="alert alert-secondary">
                <i class="fas fa-info-circle"></i> No items in warehouse yet.
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Removed duplicate minimal Found Item Modal to avoid duplication -->

<!-- Lost Item Form Modal -->
<div class="modal fade" id="lostItemModal" tabindex="-1" aria-labelledby="lostItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="lostItemModalLabel">
                    <i class="fas fa-plus-circle"></i> Report Lost Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/add_product" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="lost_name" class="form-label">Item Name *</label>
                                <input type="text" name="name" id="lost_name" class="form-control" 
                                       placeholder="e.g., iPhone, Water Bottle, Keys" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="lost_value" class="form-label">Item Value (Optional)</label>
                                <input type="number" name="price" id="lost_value" class="form-control" 
                                       placeholder="Estimated value in BDT">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="lost_description" class="form-label">Description *</label>
                        <textarea name="description" id="lost_description" class="form-control" rows="4" 
                                  placeholder="Describe the item and any identifying features..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="lost_location" class="form-label">Lost Location (Optional)</label>
                        <input type="text" name="location" id="lost_location" class="form-control" 
                               placeholder="e.g., Library, Cafeteria, Room 501, etc.">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Item Photos (Optional)</label>
                        <div id="lostPhotosContainer" class="d-grid gap-2">
                            <input type="file" name="item_photos" class="form-control" accept="image/*" multiple>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMorePhotos('lostPhotosContainer')">
                                <i class="fas fa-plus"></i> Add another photo
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">Tip: You can multi-select in the file dialog, or add more fields.</small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Report Lost Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Found Item Form Modal -->
<div class="modal fade" id="foundItemModal" tabindex="-1" aria-labelledby="foundItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="foundItemModalLabel">
                    <i class="fas fa-hand-holding-heart"></i> Report Found Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/report_found_item" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="found_name" class="form-label">Item Name *</label>
                                <input type="text" name="name" id="found_name" class="form-control" 
                                       placeholder="e.g., iPhone, Water Bottle, Keys" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="found_value" class="form-label">Item Value (Optional)</label>
                                <input type="number" name="price" id="found_value" class="form-control" 
                                       placeholder="Estimated value in BDT">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="found_description" class="form-label">Description *</label>
                        <textarea name="description" id="found_description" class="form-control" rows="3" 
                                  placeholder="Describe the item and any identifying features..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="found_location" class="form-label">Found Location *</label>
                        <input type="text" name="location" id="found_location" class="form-control" 
                               placeholder="e.g., Library, Cafeteria, Room 501, etc." required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Item Photos (Optional)</label>
                        <div id="foundPhotosContainer" class="d-grid gap-2">
                            <input type="file" name="item_photos" class="form-control" accept="image/*" multiple>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMorePhotos('foundPhotosContainer')">
                                <i class="fas fa-plus"></i> Add another photo
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">Tip: You can multi-select in the file dialog, or add more fields.</small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload"></i> Report Found Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Contact Information Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactModalLabel">
                    <i class="fas fa-phone text-primary"></i> Contact Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="contactInfoContent">
                    <!-- Contact information will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Item Detail Modal (enlarged view) -->
<div class="modal fade" id="itemDetailModal" tabindex="-1" aria-labelledby="itemDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemDetailLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detailCarousel" class="position-relative mb-3" data-index="0" style="width:100%; height:420px; background:#f8f9fa; border-radius:.5rem; overflow:hidden;"></div>
                <div id="detailMeta"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function addMorePhotos(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'item_photos';
    input.className = 'form-control';
    input.accept = 'image/*';
    container.appendChild(input);
}

// Function to show the lost item form modal
function showLostItemForm() {
    new bootstrap.Modal(document.getElementById('lostItemModal')).show();
}

// Function to show the found item form modal
function showFoundItemForm() {
    new bootstrap.Modal(document.getElementById('foundItemModal')).show();
}

// Simple carousel logic
function showSlide(containerId, index) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const imgs = el.querySelectorAll('img');
    if (imgs.length === 0) return;
    const count = imgs.length;
    const newIndex = ((index % count) + count) % count;
    imgs.forEach((img, i) => { img.style.display = (i === newIndex ? 'block' : 'none'); });
    el.setAttribute('data-index', newIndex);
}

function changeSlide(containerId, delta) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const current = parseInt(el.getAttribute('data-index') || '0', 10);
    showSlide(containerId, current + delta);
}

function initCarousels() {
    document.querySelectorAll('.photo-carousel').forEach((c) => {
        const id = c.getAttribute('id');
        if (id) showSlide(id, 0);
    });
}

// Click-to-open detail modal (delegate)
document.addEventListener('click', (evt) => {
    const card = evt.target.closest('.item-card');
    if (!card) return;
    if (evt.target.closest('.btn, .form-delete-item, .carousel-prev, .carousel-next')) return;
        const data = JSON.parse(card.getAttribute('data-item') || '{}');
        const modalEl = document.getElementById('itemDetailModal');
        if (!modalEl) return;
        modalEl.querySelector('#itemDetailLabel').textContent = data.name || 'Item details';
        const carousel = modalEl.querySelector('#detailCarousel');
        const meta = modalEl.querySelector('#detailMeta');
        carousel.innerHTML = '';
        const photos = Array.isArray(data.photos) ? data.photos : (data.photos ? [data.photos] : []);
        photos.forEach((p) => {
            const img = document.createElement('img');
            img.src = `${window.location.origin}${window.location.pathname.replace(/\\/g,'/')}`.replace(/\/[^/]*$/, '/') + `static/uploads/${p}`;
            img.style.display = 'none';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            carousel.appendChild(img);
        });
        if (photos.length > 1) {
            const left = document.createElement('button');
            left.className = 'btn btn-sm btn-dark position-absolute top-50 start-0 translate-middle-y';
            left.style.opacity = '0.7';
            left.innerHTML = '<i class="fas fa-chevron-left"></i>';
            left.onclick = (e) => { e.stopPropagation(); changeSlide('detailCarousel', -1); };
            const right = document.createElement('button');
            right.className = 'btn btn-sm btn-dark position-absolute top-50 end-0 translate-middle-y';
            right.style.opacity = '0.7';
            right.innerHTML = '<i class="fas fa-chevron-right"></i>';
            right.onclick = (e) => { e.stopPropagation(); changeSlide('detailCarousel', 1); };
            carousel.appendChild(left);
            carousel.appendChild(right);
        }
        carousel.id = 'detailCarousel';
        carousel.setAttribute('data-index', '0');
        showSlide('detailCarousel', 0);
        const parts = [];
        if (data.value) parts.push(`<p><strong>Value:</strong> $${data.value}</p>`);
        parts.push(`<p>${data.description || ''}</p>`);
        if (data.location) parts.push(`<p><strong>Location:</strong> ${data.location}</p>`);
        parts.push(`<p class="text-muted"><i class="fas fa-calendar-alt"></i> Posted: ${data.posted || 'Unknown'}</p>`);
        // Action buttons row
        const actions = [];
        if (data.status !== 'warehouse') {
            const contactLabel = (data.status === 'found') ? 'Contact Finder' : 'Contact Owner';
            actions.push(`<button type="button" class="btn btn-success btn-sm me-2 btn-contact" data-item-id="${data.id}"><i class=\"fas fa-phone\"></i> ${contactLabel}</button>`);
        }
        if (data.can_mark_found) {
            actions.push(`<button type=\"button\" class=\"btn btn-info btn-sm me-2 btn-mark-found\" data-item-id=\"${data.id}\"><i class=\"fas fa-hand-holding-heart\"></i> Mark as Found</button>`);
        }
        if (data.can_delete) {
            actions.push(`<form action=\"/delete_product/${data.id}\" method=\"POST\" class=\"d-inline form-delete-item\"><button type=\"submit\" class=\"btn btn-outline-danger btn-sm\"><i class=\"fas fa-trash\"></i> Remove</button></form>`);
        }
        actions.push(`<a href=\"/poster/${data.id}\" class=\"btn btn-outline-dark btn-sm\"><i class=\"fas fa-file-pdf\"></i> Download Poster</a>`);
        parts.push(`<div class=\"mt-3\">${actions.join('')}</div>`);
        meta.innerHTML = parts.join('');
        new bootstrap.Modal(modalEl).show();
});

// Initialize after DOM ready
document.addEventListener('DOMContentLoaded', () => {
    initCarousels();
    
    // Check chat status and update UI if suspended
    checkChatStatusAndUpdateUI();
    
    // Bind carousel arrow buttons
    document.querySelectorAll('.carousel-prev').forEach((btn) => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.getAttribute('data-target-id');
            changeSlide(id, -1);
        });
    });
    document.querySelectorAll('.carousel-next').forEach((btn) => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.getAttribute('data-target-id');
            changeSlide(id, 1);
        });
    });
    // Delegate actions inside detail modal
    const detailModal = document.getElementById('itemDetailModal');
    if (detailModal) {
        detailModal.addEventListener('click', (e) => {
            const delForm = e.target.closest('.form-delete-item');
            if (delForm) {
                e.stopPropagation();
                if (!confirm('Are you sure you want to remove this item?')) {
                    e.preventDefault();
                }
                return;
            }
            const contactBtn = e.target.closest('.btn-contact');
            if (contactBtn) {
                e.stopPropagation();
                const id = contactBtn.getAttribute('data-item-id');
                if (id) showContactInfo(id);
                return;
            }
            const markFoundBtn = e.target.closest('.btn-mark-found');
            if (markFoundBtn) {
                e.stopPropagation();
                const id = markFoundBtn.getAttribute('data-item-id');
                if (id) markAsFound(id);
                return;
            }
        });
    }
});

// Delegate button actions so inline onclicks aren't needed
document.addEventListener('click', (e) => {
    const contactBtn = e.target.closest('.btn-contact');
    if (contactBtn) {
        e.stopPropagation();
        const id = contactBtn.getAttribute('data-item-id');
        if (id) showContactInfo(id);
        return;
    }
    const chatBtn = e.target.closest('.btn-chat');
    if (chatBtn) {
        e.stopPropagation();
        const id = chatBtn.getAttribute('data-item-id');
        if (id) startChatFromItem(id);
        return;
    }
    const markFoundBtn = e.target.closest('.btn-mark-found');
    if (markFoundBtn) {
        e.stopPropagation();
        const id = markFoundBtn.getAttribute('data-item-id');
        if (id) markAsFound(id);
        return;
    }
    const editBtn = e.target.closest('.btn-edit');
    if (editBtn) {
        e.stopPropagation();
        const id = editBtn.getAttribute('data-item-id');
        const status = editBtn.getAttribute('data-item-status');
        if (id) openEditModal(parseInt(id, 10), status);
        return;
    }
});

// Helper to show contact modal stacked above detail modal
function showStackedContactModal() {
    const contactEl = document.getElementById('contactModal');
    if (!contactEl) return;
    contactEl.classList.add('stacked-modal');
    const modal = bootstrap.Modal.getOrCreateInstance(contactEl);
    modal.show();
    // Raise the latest backdrop above the lower modal/backdrop
    setTimeout(() => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length) {
            backdrops.forEach(b => (b.style.zIndex = 1050));
            backdrops[backdrops.length - 1].style.zIndex = 1060;
        }
    }, 10);
}

// Function to show contact information for items (lost or found)
function showContactInfo(itemId) {
    fetch(`/get_contact_info/${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('contactInfoContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${data.error}
                    </div>
                `;
            } else {
                // Determine the icon and color based on contact type
                const isFound = data.contact_type === 'finder';
                const iconClass = isFound ? 'fas fa-check-circle text-success' : 'fas fa-exclamation-triangle text-warning';
                const titleClass = isFound ? 'text-success' : 'text-warning';
                const title = isFound ? 'Item Found!' : 'Item Lost';
                const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + encodeURIComponent(data.email || '');
                
                document.getElementById('contactInfoContent').innerHTML = `
                    <div class="text-center">
                        <h6 class="${titleClass} mb-3">
                            <i class="${iconClass}"></i> ${title}
                        </h6>
                        <p><strong>Item:</strong> ${data.item_name}</p>
                        <p><strong>${isFound ? 'Found by:' : 'Lost by:'}</strong> ${data.contact_name}</p>
                        <p class="text-muted small">${data.message}</p>
                        <hr>
                        <div class="row">
                            <div class="col-12 col-md-6 mb-3 mb-md-0">
                                <div class="d-flex align-items-center justify-content-center text-break">
                                    <i class="fas fa-phone text-primary me-2"></i>
                                    <div class="w-100">
                                        <small class="text-muted d-block">Phone</small>
                                        <strong class="d-inline-block w-100">${data.phone}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center justify-content-center text-break">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <div class="w-100">
                                        <small class="text-muted d-block">Email</small>
                                        <a href="${gmailUrl}" target="_blank" rel="noopener" class="d-inline-block w-100 text-decoration-none">
                                            <strong>${data.email}</strong>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            // Show the modal stacked
            showStackedContactModal();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('contactInfoContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading contact information. Please try again.
                </div>
            `;
            showStackedContactModal();
        });
}

// Function to mark an item as found
function markAsFound(itemId) {
    if (confirm('Are you sure you found this item? This will mark it as found and you will be listed as the finder.')) {
        fetch(`/mark_found/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Item marked as found successfully!');
                // Reload the page to show updated status
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking item as found. Please try again.');
        });
    }
}

// Check chat status and disable chat buttons if suspended
async function checkChatStatusAndUpdateUI() {
    try {
        const res = await fetch('/api/chat/status');
        if (res.ok) {
            const data = await res.json();
            if (!data.chat_enabled) {
                // Disable all chat buttons
                document.querySelectorAll('.btn-chat').forEach(btn => {
                    btn.disabled = true;
                    btn.title = data.message;
                    btn.innerHTML = '<i class="fas fa-comment-slash"></i> Chat Disabled';
                    btn.classList.remove('btn-outline-success', 'btn-outline-warning');
                    btn.classList.add('btn-secondary');
                });
                
                // Add warning banner at the top
                const existingWarning = document.getElementById('chat-disabled-warning');
                if (!existingWarning) {
                    const warningDiv = document.createElement('div');
                    warningDiv.id = 'chat-disabled-warning';
                    warningDiv.className = 'alert alert-warning alert-dismissible fade show';
                    warningDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Chat Disabled:</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    const container = document.querySelector('.container');
                    if (container) {
                        container.insertBefore(warningDiv, container.firstChild);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error checking chat status:', error);
    }
}

// Start chat with the item's reporter and redirect to chat page
function startChatFromItem(itemId) {
    // Check if chat is disabled before starting
    fetch('/api/chat/status')
        .then(res => res.json())
        .then(data => {
            if (!data.chat_enabled) {
                alert(data.message || 'Your chat has been disabled due to multiple reports.');
                return;
            }
            
            // Proceed with starting chat
            return fetch(`/api/chat/start_from_item/${itemId}`, { method: 'POST' });
        })
        .then(res => {
            if (!res) return; // Chat is disabled
            return res.json().then(j => ({ ok: res.ok, body: j }));
        })
        .then(({ ok, body }) => {
            if (!ok || body.error) {
                alert(body.error || 'Failed to start chat');
                return;
            }
            const convoId = body.conversation_id;
            window.location.href = `/chat?conversation_id=${convoId}`;
        })
        .catch(err => {
            console.error(err);
            alert('Failed to start chat');
        });
}

// ------- Edit flow: reuse existing modals, prefill, and post to /edit_item/<id> -------
function openEditModal(itemId, status) {
    // Find the card data payload
    const card = document.querySelector(`#item-${itemId} .item-card`);
    if (!card) return;
    let data = {};
    try { data = JSON.parse(card.getAttribute('data-item') || '{}'); } catch (_) { data = {}; }

    if (status === 'found') {
        // Use found modal
        const modalEl = document.getElementById('foundItemModal');
        if (!modalEl) return;
        modalEl.querySelector('#foundItemModalLabel').innerHTML = '<i class="fas fa-edit"></i> Edit Found Item';
        const form = modalEl.querySelector('form');
        form.action = `/edit_item/${itemId}`;
        form.method = 'POST';
        form.querySelector('#found_name').value = data.name || '';
        const valEl = form.querySelector('#found_value');
        if (valEl) valEl.value = data.value || '';
        const descEl = form.querySelector('#found_description');
        if (descEl) descEl.value = data.description || '';
        const locEl = form.querySelector('#found_location');
        if (locEl) locEl.value = data.location || '';
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        new bootstrap.Modal(modalEl).show();
    } else {
        // Use lost modal for lost/warehouse
        const modalEl = document.getElementById('lostItemModal');
        if (!modalEl) return;
        modalEl.querySelector('#lostItemModalLabel').innerHTML = '<i class="fas fa-edit"></i> Edit Lost Item';
        const form = modalEl.querySelector('form');
        form.action = `/edit_item/${itemId}`;
        form.method = 'POST';
        form.querySelector('#lost_name').value = data.name || '';
        const valEl = form.querySelector('#lost_value');
        if (valEl) valEl.value = data.value || '';
        const descEl = form.querySelector('#lost_description');
        if (descEl) descEl.value = data.description || '';
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        new bootstrap.Modal(modalEl).show();
    }
}

// Reset forms to add mode when modals are closed
document.addEventListener('hidden.bs.modal', (e) => {
    const el = e.target;
    if (el.id === 'lostItemModal') {
        const form = el.querySelector('form');
        if (form) {
            form.action = '/add_product';
            el.querySelector('#lostItemModalLabel').innerHTML = '<i class="fas fa-plus-circle"></i> Report Lost Item';
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-upload"></i> Report Lost Item';
            form.reset();
        }
    } else if (el.id === 'foundItemModal') {
        const form = el.querySelector('form');
        if (form) {
            form.action = '/report_found_item';
            el.querySelector('#foundItemModalLabel').innerHTML = '<i class="fas fa-hand-holding-heart"></i> Report Found Item';
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-upload"></i> Report Found Item';
            form.reset();
        }
    }
});

// Warehouse timer functionality
function updateTimers() {
    document.querySelectorAll('[id^="timer-found-"]').forEach((el) => {
        const idStr = el.id.replace('timer-found-', '');
        const id = parseInt(idStr, 10);
        if (!Number.isNaN(id)) updateTimer(id, 'found');
    });
}

function updateTimer(itemId, type) {
    console.log(`Updating timer for item ${itemId} (${type})`);
    fetch(`/get_time_remaining/${itemId}`)
        .then(response => {
            console.log(`Response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`Timer data for item ${itemId}:`, data);
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            const timerElement = document.getElementById(`timer-${type}-${itemId}`);
            if (timerElement) {
                timerElement.textContent = data.time_remaining;
                console.log(`Updated timer for item ${itemId}: ${data.time_remaining}`);
                
                // Add visual indication for low time
                if (data.time_remaining.includes('h') && !data.time_remaining.includes('d')) {
                    const hours = parseInt(data.time_remaining.split('h')[0]);
                    if (hours < 24) {
                        timerElement.className = 'text-danger';
                    } else if (hours < 72) {
                        timerElement.className = 'text-warning';
                    }
                }
            } else {
                console.error(`Timer element not found: timer-${type}-${itemId}`);
            }
        })
        .catch(error => {
            console.error('Error updating timer:', error);
        });
}

// Update timers every minute
setInterval(updateTimers, 60000);

// Initial timer update
updateTimers();

// ---------------- In-app Notifications ----------------
let notificationsOpen = false;

function toggleNotifications() {
    const dropdown = document.getElementById('notifDropdown');
    notificationsOpen = !notificationsOpen;
    dropdown.style.display = notificationsOpen ? 'block' : 'none';
    if (notificationsOpen) {
        fetchNotifications();
    }
}

function fetchNotifications() {
    fetch('/notifications')
        .then(res => res.json())
        .then(data => {
            const listEl = document.getElementById('notifList');
            const badgeEl = document.getElementById('notifBadge');
            const emptyEl = document.getElementById('noNotif');
            listEl.innerHTML = '';
            if (!data.notifications || data.notifications.length === 0) {
                emptyEl.classList.remove('d-none');
            } else {
                emptyEl.classList.add('d-none');
                data.notifications.forEach(n => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div class="me-2">
                                <div class="fw-semibold ${n.is_read ? '' : 'text-primary'}">${n.title}</div>
                                <div class="small text-muted">${n.message}</div>
                                <div class="small text-muted">${n.created_at || ''}</div>
                            </div>
                            <a class="stretched-link" href="${n.url || '#'}"></a>
                        </div>`;
                    listEl.appendChild(li);
                });
            }
            if (data.unread_count && data.unread_count > 0) {
                badgeEl.textContent = data.unread_count;
                badgeEl.classList.remove('d-none');
            } else {
                badgeEl.classList.add('d-none');
            }
        });
}

function markAllRead() {
    fetch('/notifications/mark_read', { method: 'POST' })
        .then(res => res.json())
        .then(_ => fetchNotifications());
}

// Poll notifications every 20s
setInterval(fetchNotifications, 20000);

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    const bell = document.getElementById('notifBell');
    const dropdown = document.getElementById('notifDropdown');
    if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
        notificationsOpen = false;
    }
});

// ---------------- Chat Status Check ----------------
async function checkChatStatus() {
    try {
        const res = await fetch('/api/chat/status');
        if (res.ok) {
            const data = await res.json();
            const indicator = document.getElementById('chat-status-indicator');
            if (!data.chat_enabled && indicator) {
                indicator.classList.remove('d-none');
                indicator.title = data.message || 'Chat disabled due to reports';
            } else if (indicator) {
                indicator.classList.add('d-none');
            }
        }
    } catch (error) {
        console.error('Error checking chat status:', error);
    }
}

// Check chat status when page loads and every 30 seconds
document.addEventListener('DOMContentLoaded', checkChatStatus);
setInterval(checkChatStatus, 30000);
</script>
</body>
</html>
