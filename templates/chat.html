<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chats</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f6f8fb; }
        .chat-container { display: flex; height: calc(100vh - 120px); gap: 16px; }
        .chat-list { width: 32%; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .chat-list-header { padding: 12px 14px; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; gap: 8px; }
        .chat-search { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; width: 100%; }
        .chat-threads { overflow-y: auto; }
        .chat-item { padding: 12px 14px; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .chat-item:hover { background: #f9fafb; }
        .chat-item.active { background: #eef3ff; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-weight: 600; }
        .chat-item .name { font-weight: 600; }
        .chat-item .preview { font-size: 12px; color: #6b7280; }
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; }
        .chat-header { padding: 12px 16px; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; gap: 12px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 18px; background: #f8fafc; }
        .date-divider { text-align: center; margin: 12px 0; color: #6b7280; font-size: 12px; }
        .msg { margin: 8px 0; max-width: 70%; padding: 10px 12px; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .msg.me { background: #2563eb; color: #fff; margin-left: auto; border-bottom-right-radius: 6px; }
        .msg.other { background: #fff; border: 1px solid #e5e7eb; color: #111827; border-bottom-left-radius: 6px; }
        .msg .meta { margin-top: 4px; font-size: 11px; opacity: 0.8; }
        .chat-input { padding: 12px; border-top: 1px solid #eef2f7; display: flex; align-items: flex-end; gap: 10px; }
        .chat-textarea { flex: 1; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; resize: none; max-height: 180px; min-height: 42px; }
        .send-btn { min-width: 80px; }
    </style>
    <script>
        let currentConversationId = null;
        let lastMessageId = null;

        async function fetchConversations() {
            const res = await fetch('/api/chat/conversations');
            if (!res.ok) return;
            const data = await res.json();
            const list = document.getElementById('chat-threads');
            list.innerHTML = '';
            (data.conversations || []).forEach(c => {
                const other = c.other_user || {};
                const displayName = ((other.first_name || '') + ' ' + (other.last_name || '')).trim() || other.username || ('User #' + (other.id || ''));
                const initials = (displayName.split(' ').map(p=>p[0]).join('').substring(0,2) || 'U').toUpperCase();
                const div = document.createElement('div');
                div.className = 'chat-item' + (c.id === currentConversationId ? ' active' : '');
                div.innerHTML = `
                    <div class="avatar">${initials}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="name">${escapeHtml(displayName)}</div>
                            <div class="text-muted" style="font-size:12px">${c.created_at || ''}</div>
                        </div>
                        <div class="preview text-truncate">&nbsp;</div>
                    </div>`;
                div.onclick = () => selectConversation(c.id, displayName, initials);
                list.appendChild(div);
            });
        }

        async function selectConversation(id, displayName, initials) {
            currentConversationId = id;
            lastMessageId = null; // reset
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const threads = document.getElementById('chat-threads');
            const match = Array.from(threads.children).find(el => el.onclick && String(el.onclick).includes(`(${id}`));
            if (match) match.classList.add('active');
            // Update header
            if (displayName) {
                document.getElementById('chat-title-name').textContent = displayName;
                document.getElementById('chat-title-avatar').textContent = initials || '?';
            }
            await renderMessages(true);
        }

        function appendMessage(m) {
            const meId = parseInt(document.body.getAttribute('data-me-id') || '0', 10);
            const wrap = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'msg ' + (m.sender_id === meId ? 'me' : 'other');
            let bodyHtml = '';
            if (m.attachment) {
                const isImage = /\.(png|jpg|jpeg|gif|webp)$/i.test(m.attachment);
                if (isImage) {
                    bodyHtml += `<div><a href="${m.attachment}" target="_blank"><img src="${m.attachment}" alt="attachment" style="max-width:220px;border-radius:8px" /></a></div>`;
                } else {
                    const fileName = m.attachment.split('/').pop();
                    bodyHtml += `<div><a href="${m.attachment}" target="_blank"><i class="fas fa-paperclip"></i> ${escapeHtml(fileName)}</a></div>`;
                }
            }
            if ((m.content || '').trim()) {
                bodyHtml += `<div>${escapeHtml(m.content)}</div>`;
            }
            div.innerHTML = `${bodyHtml}<div class="meta">${m.created_at || ''}</div>`;
            wrap.appendChild(div);
            wrap.scrollTop = wrap.scrollHeight;
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
        }

        async function renderMessages(reload=false) {
            if (!currentConversationId) return;
            const params = lastMessageId ? ('?since_id=' + lastMessageId) : '';
            const res = await fetch(`/api/chat/${currentConversationId}/messages${params}`);
            if (!res.ok) return;
            const data = await res.json();
            const msgs = data.messages || [];
            const container = document.getElementById('chat-messages');
            if (reload) container.innerHTML = '';
            // Optional: simple date divider by day
            let lastDate = container.getAttribute('data-last-date') || '';
            msgs.forEach(m => {
                const day = (m.created_at || '').split(' ')[0] || '';
                if (day && day !== lastDate) {
                    const dd = document.createElement('div');
                    dd.className = 'date-divider';
                    dd.textContent = day;
                    container.appendChild(dd);
                    lastDate = day;
                    container.setAttribute('data-last-date', lastDate);
                }
                appendMessage(m);
                lastMessageId = Math.max(lastMessageId || 0, m.id);
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chat-textarea');
            const fileInput = document.getElementById('chat-file');
            const content = input.value.trim();
            if (!currentConversationId) return;
            
            // Check if chat is disabled before sending
            const statusRes = await fetch('/api/chat/status');
            if (statusRes.ok) {
                const statusData = await statusRes.json();
                if (!statusData.chat_enabled) {
                    alert('Your chat has been disabled due to multiple reports. You cannot send messages at this time.');
                    return;
                }
            }
            
            let res;
            if (fileInput.files && fileInput.files.length > 0) {
                const form = new FormData();
                if (content) form.append('content', content);
                form.append('file', fileInput.files[0]);
                res = await fetch(`/api/chat/${currentConversationId}/messages`, { method: 'POST', body: form });
            } else {
                if (!content) return;
                res = await fetch(`/api/chat/${currentConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
            }
            
            if (res.ok) {
                input.value = '';
                if (fileInput) fileInput.value = '';
                autoResize(input);
                await renderMessages();
            } else if (res.status === 403) {
                // Handle chat suspension error
                const errorData = await res.json();
                alert(errorData.error || 'Your chat has been disabled. Please check your profile for details.');
            }
        }

        function setupPolling() {
            setInterval(() => {
                renderMessages();
                fetchConversations();
            }, 3000);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px';
        }

        async function checkChatStatus() {
            try {
                // First check if there's already a flash message about chat being disabled
                const flashMessage = document.querySelector('.alert-danger');
                if (flashMessage && (flashMessage.textContent.includes('chat') || flashMessage.textContent.includes('suspended'))) {
                    // Chat is disabled via flash message, disable the interface immediately
                    disableChatInterface('Chat access has been restricted due to multiple reports.');
                    return;
                }
                
                const res = await fetch('/api/chat/status');
                if (res.ok) {
                    const data = await res.json();
                    if (!data.chat_enabled) {
                        disableChatInterface(data.message);
                    }
                }
            } catch (error) {
                console.error('Error checking chat status:', error);
            }
        }
        
        function disableChatInterface(message) {
            // Disable chat input and show warning
            const chatInput = document.querySelector('.chat-input');
            const textarea = document.getElementById('chat-textarea');
            const sendBtn = document.querySelector('.send-btn');
            const fileInput = document.getElementById('chat-file');
            
            if (chatInput) {
                chatInput.innerHTML = `
                    <div class="alert alert-warning mb-0 w-100">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Chat Disabled:</strong> ${message}
                        <br><small>You can still view messages but cannot send new ones.</small>
                    </div>
                `;
            }
            
            if (textarea) textarea.disabled = true;
            if (sendBtn) sendBtn.disabled = true;
            if (fileInput) fileInput.disabled = true;
            
            // Add warning to chat header
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning alert-sm mb-0 mt-2';
                warningDiv.innerHTML = `<i class="fas fa-comment-slash"></i> Chat disabled due to reports`;
                chatHeader.appendChild(warningDiv);
            }
            
            // Show warning in chat list
            const chatListWarning = document.getElementById('chat-disable-warning');
            if (chatListWarning) {
                chatListWarning.style.display = 'block';
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Check if chat is disabled via flash message first
            const flashMessage = document.querySelector('.alert-danger');
            if (flashMessage && (flashMessage.textContent.includes('chat') || flashMessage.textContent.includes('suspended'))) {
                // Chat is disabled, disable the interface immediately
                disableChatInterface('Chat access has been restricted due to multiple reports.');
            } else {
                // Check chat status via API
                await checkChatStatus();
            }
            
            // Also check for any existing suspensions in the database
            await checkForExistingSuspensions();
            
            await fetchConversations();
            const params = new URLSearchParams(window.location.search);
            const focusId = parseInt(params.get('conversation_id') || '0', 10);
            if (focusId) {
                currentConversationId = focusId;
                await renderMessages(true);
            } else {
                // Auto-select first conversation if available
                const first = document.querySelector('#chat-threads .chat-item');
                if (first && first.onclick) first.onclick();
            }
            setupPolling();
        });
        
        async function checkForExistingSuspensions() {
            try {
                const res = await fetch('/api/chat/status');
                if (res.ok) {
                    const data = await res.json();
                    if (!data.chat_enabled) {
                        disableChatInterface(data.message);
                    }
                }
            } catch (error) {
                console.error('Error checking existing suspensions:', error);
            }
        }
    </script>
    <script>
        // Simple bridge to set current user id from server-side session via inline script in base template
    </script>
</head>
<body data-me-id="{{ session.get('user_id') or 0 }}">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-comments text-primary"></i> Messages</h4>
            <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-home"></i> Home</a>
        </div>
        
        <!-- Chat Disable Warning Message -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if 'chat' in message.lower() or 'suspended' in message.lower() %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Chat Access Restricted:</strong> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="chat-container">
            <div class="chat-list">
                <div class="chat-list-header">
                    <i class="fas fa-search text-muted"></i>
                    <input class="chat-search" id="chat-search" placeholder="Search conversations" oninput="filterThreads(this.value)" />
                </div>
                
                <!-- Chat Disable Warning in Chat List -->
                <div id="chat-disable-warning" class="alert alert-warning m-2" style="display: none;">
                    <i class="fas fa-comment-slash me-2"></i>
                    <strong>Chat Disabled</strong><br>
                    <small>You can view conversations but cannot send messages due to multiple reports.</small>
                </div>
                
                <div class="chat-threads" id="chat-threads"></div>
            </div>
            <div class="chat-window">
                <div class="chat-header">
                    <div class="avatar" id="chat-title-avatar">?</div>
                    <div>
                        <div id="chat-title-name" class="fw-semibold">Select a conversation</div>
                        <div class="text-muted" style="font-size:12px">Secure direct messages</div>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input">
                    <label class="btn btn-light" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                        <input id="chat-file" type="file" style="display:none" />
                    </label>
                    <textarea id="chat-textarea" class="chat-textarea" placeholder="Type a message" oninput="autoResize(this)" onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendMessage(); }"></textarea>
                    <button class="btn btn-primary send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function filterThreads(q) {
            const query = (q || '').toLowerCase();
            document.querySelectorAll('#chat-threads .chat-item').forEach(it => {
                const name = (it.querySelector('.name')?.textContent || '').toLowerCase();
                it.style.display = name.includes(query) ? '' : 'none';
            });
        }
    </script>
</body>
</html>


